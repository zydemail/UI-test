define(function(require,exports,module){function createConstructor(a){function b(){$.extend(!0,this,this.$self.$attribute)}return b.$className=a,b}function createClass(a,b){var c=createConstructor(a),d=c.prototype={};return d.$self=c,c.$attribute={},addMembers(c,b),c}function addMembers(a,b){b=b||{};var c=null,d=null;eachPlainObject(b,function(b,e){if("static"==b)$.extend(!0,a,e);else if("mixins"==b){e=$.isArray(e)?e:[e];var f=e.length;if(f>0){c=[{}];for(var g=0;g<f;g++){var h=e[g];h.$className&&c.push(h.prototype)}}}else"extend"==b?e.$className&&(d=e):"function"==typeof e?(e.$owner=a,e.$name=b,a.prototype[b]=e):a.$attribute[b]=e}),null!==c&&c.length>1&&(addMembers(a,$.extend.apply(null,c)),a.prototype.$self=a),null!==d&&extend(a,d)}function chain(a){var b=Object.create?Object.create(a):function(a){var b=function(){};b.prototype=a;var c=new b;return b.prototype=null,c}(a);return $.extend(!0,b,a.$self.$attribute)}function extend(a,b){var c=chain(b.prototype);$.extend(!0,c,a.prototype),a.prototype=c,a.$superclass=b.prototype,a.$attribute=$.extend(!0,{},b.$attribute,a.$attribute)}function getObjectValue(a,b){if(!b)return null;for(var c=a,d=b.split(".");void 0!==(b=d.shift());)if(c=c[b],void 0===c)return;return c}function setObjectValue(a,b,c){if(b&&c){for(var d=a,e=b.split("."),f=e.length-1,g=0;g<f;g++)b=e[g],d[b]||(d[b]={}),d=d[b];d[e[f]]=c}}function removeObjectValue(a,b){if(b){for(var c=a,d=b.split("."),e=d.length-1,f=0;f<e;f++){if(b=d[f],void 0===c[b])return;c=c[b]}delete c[d[e]]}}function format(a,b){return a=a||"",b=b||[],0===b.length?"":a.replace(/\{(\d+)\}/g,function(){return b[arguments[1]]||""})}function error(){var a=format(glue.ERROR_FORMAT,arguments);throw a}function find(a,b){return a.find("[glue-"+b+"],[data-"+b+"]")}function parents(a,b){return a.parents("[glue-"+b+"],[data-"+b+"]")}function attr(a,b){return a.attr("glue-"+b)||a.attr("data-"+b)}function eachPlainObject(a,b){for(var c in a)a.hasOwnProperty(c)&&b.call(a,c,a[c])}function defineProperty(a){function b(a,b){var c=b.substr(1);void 0===getObjectValue(a,c)&&Object.defineProperty(a,b.substr(1),{get:function(){var c=a[b];return c.$node?c.$value:c},set:function(c){var d=a[b];if(d.$node){if(c===d.$value)return;var e=d.$value;d.$value=c;for(var f=d.$node.length,g=0;g<f;g++){var h=d.$node[g];h.$directive.execute(h.$nodes,h.$name,d.$key,d.$value,e,d.$model)}}else setProperty(d,c)}})}eachPlainObject(a,function(c,d){b(a,c),d.$node||defineProperty(d)})}function setProperty(a,b){return $.isPlainObject(b)?void eachPlainObject(b,function(b,c){a["$"+b]&&(a[b]=c)}):void error(glue.INVALID_DATA,"not a plain object")}var Event=createClass("Event",{addDomListener:function(){var a=this.rootElement;return a.on.apply(a,arguments),this},removeDomListener:function(){var a=this.rootElement;return a.off.apply(a,arguments),this}}),Base=createClass("Base",{mixins:[Event],autoInit:!0,rootElement:null,nodes:null,listeners:null,messages:null,init:function(){},bindEvent:function(){function a(a,c){"function"==typeof c&&b.addDomListener(a,function(a){for(var d=attr(b.rootElement,"node-ref"),e=$(a.target);b!=e.prop("owner")&&!attr(e,"node")&&!attr(e,"type");){if(d&&(d=$.trim(d))&&(e.prop("tagName").toLowerCase()==d.toLowerCase()||e.hasClass(d))){e.$ref=!0;break}e=e.parent()}c.call(b,a,e,attr(e,"node")||attr(e,"type")||e.$ref&&d||null)})}var b=this,c=this.listeners||{};eachPlainObject(c,function(b,c){a(b,c)})},destroy:function(){glue.destroy(this.id)},onMessage:function(a,b){},callParent:function(a){var b=this.callParent.caller;return b.$owner.$superclass[b.$name].apply(this,a||[])},updateComponentNodes:function(){var a=this,b=find(a.rootElement,"node").toArray().filter(function(b){return parents($(b),"component")[0]==a.rootElement[0]});a.nodes={};for(var c=b.length,d=0;d<c;d++){var e=$(b[d]);a.nodes[attr(e,"node")]=e}},updateNodes:function(a){this.updateComponentNodes(),Model.init(this),glue.initComponent(this.rootElement,a)}}),Directive=createClass("Directive",{"static":{$GLUE_CLASS:"glue-class",$GLUE_ATTRIBUTE:"glue-attribute",$GLUE_BIND:"glue-bind",$GLUE_BIND_HTML:"glue-bind-html",$GLUE_SHOW:"glue-show",$GLUE_HIDE:"glue-hide",$GLUE_REPEAT:"glue-repeat",$directive:{},getInstance:function(a){return Directive.$directive[a.toLowerCase()]||(a.indexOf("glue")<0?Directive.$directive[Directive.$GLUE_ATTRIBUTE]:null)},create:function(a,b){var c=new Directive;$.extend(!0,c,b||{}),c.$name=a,Directive.$directive[c.$name]=c}},execute:function(a,b,c,d,e,f){},compute:function(a,b){var c=[],d=0,e=a.attr(this.$name);return e="return "+e.replace(/(\w[.\w]*)/g,function(){var a=arguments[1];if(isNaN(Number(a))&&"'"!=arguments[3][arguments[2]-1]){a=getObjectValue(b,a);var e="arguments["+d++ +"]";return c.push(a),e}return a}),new Function(e).apply(null,c)}});Directive.create(Directive.$GLUE_ATTRIBUTE,{execute:function(a,b,c,d,e,f){a.attr(b,this.compute(a,f))}}),Directive.create(Directive.$GLUE_CLASS,{execute:function(a,b,c,d,e,f){var g=this.compute(a,f);a.removeClass(a.oldCls).addClass(g),a.oldCls=g}}),Directive.create(Directive.$GLUE_HIDE,{execute:function(a,b,c,d,e,f){this.compute(a,f)?a.hide():a.show()}}),Directive.create(Directive.$GLUE_BIND_HTML,{execute:function(a,b,c,d,e,f){a.html(this.compute(a,f))}}),Directive.create(Directive.$GLUE_BIND,{execute:function(a,b,c,d,e,f){a.text(this.compute(a,f))}}),Directive.create(Directive.$GLUE_REPEAT,{execute:function(a,b,c,d,e,f){if(!$.isArray(d))return void error(glue.INVALID_DATA,"repeat directive set need a array");for(var g=a.prop("outerHTML").replace(new RegExp(Directive.$GLUE_REPEAT+'=".*?"',"g"),""),h=d.length,i="",j=0;j<h;j++){var k=0===j,l=j==h-1,m=(j+1)%2===0,n=(j+1)%2!==0,o=d[j];i+=this.compile(g,j,k,l,m,n,h,o)}h>0&&(a.hide(),a[0].$ref&&a[0].$ref.remove(),a[0].$ref=$(i),a[0].$ref.show(),a[0].$ref.insertAfter(a))},compile:function(string,$index,$first,$last,$even,$odd,$length,data){return string.replace(/\{\{(.*)\}\}/g,function(){var expression=$.trim(arguments[1]);try{return eval(expression)}catch(e){return(expression=expression.split(".")).shift(),$.isPlainObject(data)?getObjectValue(data,expression.join(".")):data}})}}),Directive.create(Directive.$GLUE_SHOW,{execute:function(a,b,c,d,e,f){this.compute(a,f)?a.show():a.hide()}});var Model=createClass("Model",{"static":{init:function(a){a.$model||(new Model).init(a),a.$model.updateModel()}},$data:{},$component:null,init:function(a){this.$component=a,a.$model=this,a.model||Object.defineProperty(a,"model",{get:function(){return a.$model.$data},set:function(b){setProperty(a.$model.$data,b)}})},updateModel:function(){function a(a){return a=$(a),!(!a.attr(Directive.$GLUE_REPEAT)&&parents(a,"repeat").length>0)&&parents(a,"component")[0]==d[0]}function b(){var a=arguments[1];isNaN(Number(a))&&"'"!=arguments[3][arguments[2]-1]&&(h[a]?getObjectValue(c.$data,"$"+a.replace(/\./g,".$")).$node.push(n):(h[a]=!0,setObjectValue(c.$data,"$"+a.replace(/\./g,".$"),{$node:[n],$model:c.$component.$model.$data,$key:a,$value:""})))}var c=this,d=this.$component.rootElement,e=d.clone();find(e,"component").remove();for(var f=e.prop("outerHTML"),g=/(\S+)="[^="]*?\{\{(.*?)\}\}.*?"|(glue-\S+)="(.*?)"/gi,h={},i=g.exec(f);i;){if(!h[i[0]]){h[i[0]]=!0;var j=i[1]||i[3],k=$.trim(i[2]||i[4]),l=Directive.getInstance(j);if(l){var m=d.find("["+i[0]+"]").toArray().filter(a),n={$nodes:0===m.length?d:$(m),$name:j,$directive:l};k=j==Directive.$GLUE_REPEAT?k.split(" ").pop():k,k.replace(/(\w[.\w]*)/g,b)}}i=g.exec(f)}defineProperty(this.$data)}}),History=createClass("History",{"static":{handlers:[],fragment:null,init:function(a){a=a||{},a.trigger=a.trigger!==!1,History.root=("/"+a.root||"//").replace(/^\/+|\/+$/g,"/"),History.useHashChange=a.useHashChange!==!1,History.usePushState=a.usePushState!==!1,History.useHashChange?window.addEventListener("hashchange",History.route,!1):History.usePushState&&window.addEventListener("popstate",History.route,!1),History.navigate()},getFragment:function(a){if(!a)if(History.useHashChange){var b=window.location.hash;a=""!==b?b.substring(1):""}else if(History.usePushState){var c=(window.location.pathname+window.location.search).substring(History.root.length-1);a="/"===c.charAt(0)?c.substring(1):c}return a.replace(/^[#\/]*|\s+$/g,"")},navigate:function(a,b){if(b=b||{},b.replce=!!b.replce,b.trigger=b.trigger!==!1,a=History.getFragment(a),a!==History.fragment){if(History.useHashChange)if(b.replce){var c=window.location.href.replace(/#.*$/,"");window.location.replace(c+"#"+a)}else window.location.hash="#"+a;else if(History.usePushState){var d=History.root;""!==a&&"?"!==a.charAt(0)||(d=d.slice(0,-1)||"/");var e=d+a;window.history[b.replce?"replaceState":"pushState"](b.state||{},document.title,e)}b.trigger&&History.route(a)}},addRoute:function(a,b){a instanceof RegExp&&"function"==typeof b&&History.handlers.push({routeRegExp:a,handler:b})},route:function(a){if(a="string"==typeof a?a:History.getFragment(),History.fragment!==a){History.fragment=a;for(var b=History.handlers,c=b.length,d=0;d<c;d++){var e=b[d];e.routeRegExp.test(a)&&e.handler.apply(null,Route.parseParameters(e.routeRegExp,a))}}}}}),Route=createClass("Route",{"static":{init:function(a){if(a&&a.routes){var b=a.routes,c=a.scope||window;eachPlainObject(b,function(b,d){if("string"==typeof d&&"function"==typeof a[d]&&(d=a[d]),"function"==typeof d){var e=Route.createRouteRegExp(b);History.addRoute(e,d.bind(c))}})}},createRouteRegExp:function(a){return a=a.replace(/[\-{}\[\]+?.,\\\^$|#\s]/g,"\\$&").replace(/^\/*/g,"").replace(/\((.*?)\)/g,"(?:$1)?").replace(/(\(\?)?:\w+/g,function(a,b){return b?a:"([^/?]+)"}).replace(/\*\w*.*$/g,"([^?]*?)"),new RegExp("^"+a+"$")},parseParameters:function(a,b){var c=a.exec(b);if(null===c)return null;for(var d=[],e=c.length,f=1;f<e;f++){var g=c[f];d.push(g?decodeURIComponent(g):null)}return d},route:function(a,b){History.navigate(a,b)}}}),glue=window.APP=window.glue={};glue.COMPONENTS={},glue.COMPS={},glue.OBJ_POINTER=[],glue.SERVICES={},glue.BEHAVIORS={},glue.idSeed=0,glue.isReady=!1,glue.readyCall=[],glue.readyMsg=[],glue.debug=!1,glue.console=window.console||{log:function(a){alert(a)}},glue.ERROR_FORMAT="error: {0} [name={1}] {2}",glue.DUPLICATED_DEFINE="duplicated define component",glue.DUPLICATED_CREATE_COMPONENT="duplicated create component",glue.DUPLICATED_CREATE_SERVICE="duplicated create service",glue.DUPLICATED_CREATE_BEHAVIOR="duplicated create behavior",glue.DUPLICATED_CREATE_DIRECTIVE="duplicated create directive",glue.INIT_COMPONENT_ERROR="init component failed",glue.GET_COMPS_ERROR="get comps failed",glue.INVALID_DATA="invalid data",glue.NAMEOFSERVICE="SERVICE",glue.$=window.jQuery||window.Zepto,glue.define=function(a,b){var c=getObjectValue(glue.COMPONENTS,a);return c?(error(glue.DUPLICATED_DEFINE,a),null):(b=$.extend(!0,b||{},{extend:Base}),c=createClass(a,b),setObjectValue(glue.COMPONENTS,a,c),c)},glue.create=function(a,b){var c=attr(a,"component"),d=getObjectValue(glue.COMPONENTS,c);if(d){var e=getObjectValue(glue.COMPS,attr(a,"id"));if(e&&e.rootElement!=a&&(e.destroy(),e=null),e)error(glue.DUPLICATED_CREATE_COMPONENT,c),d=null;else{d=new d,$.extend(!0,d,b[attr(a,"id")]||{});var f=attr(a,"id")||a.attr("id")||c+"_"+glue.idSeed++;d.id=f,a.attr("glue-id",f),setObjectValue(glue.COMPS,f,d),glue.OBJ_POINTER.push(d),a.prop("owner",d),d.rootElement=a,d.updateNodes(b)}}return d},glue.destroy=function(a){var b=getObjectValue(glue.COMPS,a);if(b){b.rootElement.remove(),removeObjectValue(glue.COMPS,a);for(var c=glue.OBJ_POINTER.length,d=0;d<c;d++)if(glue.OBJ_POINTER[d]==b){glue.OBJ_POINTER.splice(d,1);break}}else error(glue.GET_COMPS_ERROR,a)},glue.getComponentInstance=function(a){return"string"!=typeof a&&(a=attr($(a),"id")||$(a).attr("id")),getObjectValue(glue.COMPS,a)},glue.createService=function(a){if(0===arguments.length)return null;var b=glue.NAMEOFSERVICE+glue.idSeed++;if(a=a||{},b&&!getObjectValue(glue.SERVICES,b)){var c={};return $.extend(!0,c,a||{}),setObjectValue(glue.SERVICES,b,c),c}return error(glue.DUPLICATED_CREATE_SERVICE,b),null},glue.createBehavior=function(a,b){b&&(a&&!getObjectValue(glue.BEHAVIORS,a)?(setObjectValue(glue.BEHAVIORS,a,b),"object"==typeof b&&glue.OBJ_POINTER.push(b)):error(glue.DUPLICATED_CREATE_BEHAVIOR,a))},glue.createDirective=function(a,b){a&&!Directive.$directive[a]?Directive.create(a,b):error(glue.DUPLICATED_CREATE_DIRECTIVE,a)},glue.createRoute=function(a){Route.init(a)},glue.changeRoute=function(a,b){Route.route(a,b)},glue.postMessage=function(a,b){if(!glue.isReady)return void glue.readyMsg.push({name:a,data:b});a=a instanceof Array?a:[a];for(var c=a.length,d=glue.OBJ_POINTER.length,e=0;e<d;e++){var f=glue.OBJ_POINTER[e];if(f.message instanceof Array&&f.onMessage)for(var g=0;g<c;g++)f.message.indexOf(a[g])>=0&&f.onMessage(a[g],b)}},glue.initComponent=function(a,b){a=$(a),b=b||{};for(var c=find(a,"component"),d=c.length,e=0;e<d;e++){var f=$(c[e]),g=f.prop("owner");if(g||(g=glue.create(f,b)),g&&!g.$init){if(g.autoInit)if(glue.debug)g.init();else try{g.init()}catch(h){error(glue.INIT_COMPONENT_ERROR,attr(f,"component"),h.message)}g.bindEvent(),g.$init=!0;var i=attr(f,"behavior");i&&glue._initBehavior_(i,g)}}},glue._initBehavior_=function(a,b){for(var c=a.replace(/,/g,";").split(";"),d=c.length,e=0;e<d;e++)a=getObjectValue(glue.BEHAVIORS,$.trim(c[e])),"function"==typeof a?a.call(b):"object"==typeof a&&"function"==typeof a.init&&a.init.call(b)},glue._done_=function(a){for(glue.isReady=!0;void 0!==(fn=glue.readyCall.shift());)fn.call();for(var b=glue.readyMsg.length,c=0;c<b;c++){var d=glue.readyMsg[c];glue.postMessage(d.name,d.data)}History.init(a)},glue.ready=function(a){glue.isReady?a.call():"function"==typeof a&&glue.readyCall.push(a)},glue.init=function(a){$(document).ready(function(){a=a||{},glue.debug=!!a.debug,glue.initComponent($("body"),a),glue._done_(a)})},glue.createDataStore=function(a){function b(a,b){var c=m,d={};$.extend(!0,d,c),d[a]=b,m=d,i(d,c)||n.forEach(function(a){var b=c,e=d,f=!0,g=!0;a.key.split(".").forEach(function(a){b&&b.hasOwnProperty(a)?b=b[a]:(f=!1,b=void 0),e&&e.hasOwnProperty(a)?e=e[a]:(g=!1,e=void 0)}),f===g&&i(e,b)||a.fn(e,b)})}function c(a){var b=m[a],c=b;return f(b)?(c={},$.extend(!0,c,b)):h(b)&&(c=[],$.extend(!0,c,b)),c}function d(a,b){a&&b&&n.push({key:a.replace(/^\s*|\s*$/g,""),fn:b})}function e(a){return Object.prototype.toString.call(a)}function f(a){return"[object Object]"===e(a)}function g(a){return"object"==typeof a}function h(a){return"[object Array]"===e(a)}function i(a,b){return a===b||(null===a||null===b||!g(a)&&!f(a)?a!==a&&b!==b:j(a,b))}function j(a,b){var c=e(a),d=e(a),g=c===d;return!!g&&(f(a)?k(a,b):h(a)?l(a,b):void 0)}function k(a,b){var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(var e=c.length;e--;){var f=c[e];if(!i(a[f],b[f]))return!1}return!0}function l(a,b){var c=a.length,d=b.length;if(c!==d)return!1;for(;c--;)if(!i(a[c],b[c]))return!1}var m=$.extend(!0,{},a||{}),n=[],o={set:b,get:c,watch:d};return o}});